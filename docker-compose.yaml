name: firecrawl

x-common-service: &common-service
  restart: unless-stopped
  networks:
    - firecrawl
  env_file:
    - .env
  labels:
    - "com.centurylinklabs.watchtower.enable=false"

services:
  firecrawl_playwright:
    <<: *common-service
    image: ghcr.io/firecrawl/playwright-service:latest
    # build: apps/playwright-service-ts
    container_name: firecrawl_playwright
    ports:
      - "${PLAYWRIGHT_PORT:-4302}:3000"

  firecrawl:
    <<: *common-service
    image: ghcr.io/firecrawl/firecrawl
    # build: apps/api
    container_name: firecrawl
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    depends_on:
      - firecrawl_cache
      - firecrawl_playwright
      - firecrawl_db
    ports:
      - "${FIRECRAWL_PORT:-3002}:${FIRECRAWL_INTERNAL_PORT:-3002}"
    command: node dist/src/harness.js --start-docker

  firecrawl_cache:
    <<: *common-service
    image: redis:alpine
    container_name: firecrawl_cache
    ports:
      - "${REDIS_PORT:-4303}:6379"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/firecrawl_redis:/data
    command: redis-server --bind 0.0.0.0 --appendonly yes --save 60 1

  firecrawl_db:
    <<: *common-service
    build: apps/nuq-postgres
    container_name: firecrawl_db
    ports:
      - "${POSTGRES_PORT:-4304}:5432"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/firecrawl_postgres:/var/lib/postgresql/data

  firecrawl_mcp:
    <<: *common-service
    build:
      context: .
      dockerfile: apps/mcp/Dockerfile
    container_name: firecrawl_mcp
    ports:
      - "${MCP_PORT:-3060}:3060"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/firecrawl_mcp_resources:/app/resources
    depends_on:
      - firecrawl
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3060/health || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  firecrawl_webhook:
    <<: *common-service
    build:
      context: ./apps/webhook
      dockerfile: Dockerfile
    container_name: firecrawl_webhook
    ports:
      - "${WEBHOOK_PORT:-52100}:52100"
    depends_on:
      - firecrawl_db
      - firecrawl_cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:52100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  firecrawl:
    driver: bridge
