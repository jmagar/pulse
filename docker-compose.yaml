name: pulse

x-common-service: &common-service
  restart: unless-stopped
  networks:
    - pulse
  env_file:
    - .env
  labels:
    - "com.centurylinklabs.watchtower.enable=false"

services:
  pulse_playwright:
    <<: *common-service
    image: ghcr.io/firecrawl/playwright-service:latest
    # build: apps/playwright-service-ts
    container_name: pulse_playwright
    ports:
      - "${PLAYWRIGHT_PORT:-50100}:3000"
    environment:
      - PORT=3000

  firecrawl:
    <<: *common-service
    image: ghcr.io/firecrawl/firecrawl
    # build: apps/api
    container_name: firecrawl
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    depends_on:
      - pulse_redis
      - pulse_playwright
      - pulse_postgres
    ports:
      - "${FIRECRAWL_PORT:-50102}:${FIRECRAWL_INTERNAL_PORT:-3002}"
    command: node dist/src/harness.js --start-docker

  pulse_redis:
    <<: *common-service
    image: redis:alpine
    container_name: pulse_redis
    ports:
      - "${REDIS_PORT:-50104}:6379"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_redis:/data
    command: redis-server --bind 0.0.0.0 --appendonly yes --save 60 1

  pulse_postgres:
    <<: *common-service
    build: apps/nuq-postgres
    container_name: pulse_postgres
    ports:
      - "${POSTGRES_PORT:-50105}:5432"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_postgres:/var/lib/postgresql/data

  pulse_mcp:
    <<: *common-service
    # Build context changed from ./apps/mcp to . for monorepo access
    # All environment variables now configured in root .env file
    build:
      context: .
      dockerfile: apps/mcp/Dockerfile
    container_name: pulse_mcp
    ports:
      - "${MCP_PORT:-50107}:3060"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_mcp/resources:/app/resources
    depends_on:
      - firecrawl
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3060/health || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  pulse_webhook:
    <<: *common-service
    build:
      context: ./apps/webhook
      dockerfile: Dockerfile
    container_name: pulse_webhook
    ports:
      - "${WEBHOOK_PORT:-50108}:52100"
    environment:
      WEBHOOK_ENABLE_WORKER: "false"  # Disable embedded worker thread
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_webhook:/app/data/bm25
    depends_on:
      - pulse_postgres
      - pulse_redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:52100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  pulse_webhook-worker:
    <<: *common-service
    build:
      context: ./apps/webhook
      dockerfile: Dockerfile
    container_name: pulse_webhook-worker
    command:
      - "python"
      - "-m"
      - "rq.cli"
      - "worker"
      - "--url"
      - "redis://pulse_redis:6379"
      - "--name"
      - "search-bridge-worker"
      - "--worker-ttl"
      - "600"
      - "indexing"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_webhook/bm25:/app/data/bm25
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_webhook/hf_cache:/app/.cache/huggingface
    depends_on:
      - pulse_postgres
      - pulse_redis
    # No healthcheck - RQ doesn't expose HTTP endpoint
    # No ports - worker doesn't serve HTTP

  pulse_change-detection:
    <<: *common-service
    image: ghcr.io/dgtlmoon/changedetection.io:latest
    container_name: pulse_change-detection
    hostname: changedetection
    ports:
      - "${CHANGEDETECTION_PORT:-50109}:5000"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_change-detection:/datastore
    depends_on:
      - pulse_playwright
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:5000/')\""]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  pulse_neo4j:
    <<: *common-service
    image: neo4j:2025.10.1-community-bullseye
    container_name: pulse_neo4j
    ports:
      - "${GRAPH_DB_HTTP_PORT:-50210}:7474"
      - "${GRAPH_DB_BOLT_PORT:-50211}:7687"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_neo4j/data:/data
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_neo4j/logs:/logs
      - ${APPDATA_BASE:-/mnt/cache/appdata}/pulse_neo4j/plugins:/plugins
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  pulse:
    external: true
