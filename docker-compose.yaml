name: firecrawl

x-common-service: &common-service
  restart: unless-stopped
  networks:
    - firecrawl
  env_file:
    - .env
  labels:
    - "com.centurylinklabs.watchtower.enable=false"

services:
  firecrawl_playwright:
    <<: *common-service
    image: ghcr.io/firecrawl/playwright-service:latest
    # build: apps/playwright-service-ts
    container_name: firecrawl_playwright
    ports:
      - "${PLAYWRIGHT_PORT:-4302}:3000"

  firecrawl:
    <<: *common-service
    image: ghcr.io/firecrawl/firecrawl
    # build: apps/api
    container_name: firecrawl
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    depends_on:
      - firecrawl_cache
      - firecrawl_playwright
      - firecrawl_db
    ports:
      - "${FIRECRAWL_PORT:-3002}:${FIRECRAWL_INTERNAL_PORT:-3002}"
    command: node dist/src/harness.js --start-docker

  firecrawl_cache:
    <<: *common-service
    image: redis:alpine
    container_name: firecrawl_cache
    ports:
      - "${REDIS_PORT:-4303}:6379"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/firecrawl_redis:/data
    command: redis-server --bind 0.0.0.0 --appendonly yes --save 60 1

  firecrawl_db:
    <<: *common-service
    build: apps/nuq-postgres
    container_name: firecrawl_db
    ports:
      - "${POSTGRES_PORT:-4304}:5432"
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/firecrawl_postgres:/var/lib/postgresql/data

  firecrawl_mcp:
    <<: *common-service
    build:
      context: .
      dockerfile: apps/mcp/Dockerfile
    container_name: firecrawl_mcp
    ports:
      - "${MCP_PORT:-3060}:3060"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - MCP_PORT=3060
      - SKIP_HEALTH_CHECKS=true  # Skip Firecrawl auth health check for integration testing
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost:3060}
      - ENABLE_RESUMABILITY=${ENABLE_RESUMABILITY:-true}
      - MCP_OPTIMIZE_FOR=${MCP_OPTIMIZE_FOR:-cost}
      - MCP_RESOURCE_STORAGE=${MCP_RESOURCE_STORAGE:-filesystem}
      - MCP_RESOURCE_FILESYSTEM_ROOT=/app/resources
      - MCP_RESOURCE_TTL=${MCP_RESOURCE_TTL:-86400}
      - DEBUG=${DEBUG:-false}
      - MCP_FIRECRAWL_API_KEY=${MCP_FIRECRAWL_API_KEY:-self-hosted-no-auth}
      - MCP_FIRECRAWL_BASE_URL=http://firecrawl:${FIRECRAWL_INTERNAL_PORT:-3002}
      - MCP_LLM_PROVIDER=${MCP_LLM_PROVIDER:-openai-compatible}
      - MCP_LLM_API_BASE_URL=${MCP_LLM_API_BASE_URL:-${OPENAI_BASE_URL}}
      - MCP_LLM_MODEL=${MCP_LLM_MODEL:-${MODEL_NAME}}
      - MCP_MAP_DEFAULT_COUNTRY=${MCP_MAP_DEFAULT_COUNTRY:-US}
      - MCP_MAP_DEFAULT_LANGUAGES=${MCP_MAP_DEFAULT_LANGUAGES:-en-US}
      - MCP_MAP_MAX_RESULTS_PER_PAGE=${MCP_MAP_MAX_RESULTS_PER_PAGE:-200}
      - FORCE_COLOR=1
    volumes:
      - ${APPDATA_BASE:-/mnt/cache/appdata}/firecrawl_mcp_resources:/app/resources
    depends_on:
      - firecrawl
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3060/health || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  firecrawl_webhook:
    <<: *common-service
    build:
      context: ./apps/webhook
      dockerfile: Dockerfile
    container_name: firecrawl_webhook
    ports:
      - "${WEBHOOK_PORT:-52100}:52100"
    environment:
      - WEBHOOK_HOST=${WEBHOOK_HOST:-0.0.0.0}
      - WEBHOOK_PORT=52100
      - WEBHOOK_API_SECRET=${WEBHOOK_API_SECRET}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - WEBHOOK_CORS_ORIGINS=${WEBHOOK_CORS_ORIGINS:-http://localhost:3000}
      - WEBHOOK_REDIS_URL=redis://firecrawl_cache:6379
      - WEBHOOK_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-firecrawl}:${POSTGRES_PASSWORD}@firecrawl_db:5432/${POSTGRES_DB:-firecrawl_db}
      - WEBHOOK_QDRANT_URL=${WEBHOOK_QDRANT_URL}
      - WEBHOOK_QDRANT_COLLECTION=${WEBHOOK_QDRANT_COLLECTION:-firecrawl_docs}
      - WEBHOOK_VECTOR_DIM=${WEBHOOK_VECTOR_DIM:-1024}
      - WEBHOOK_TEI_URL=${WEBHOOK_TEI_URL}
      - WEBHOOK_EMBEDDING_MODEL=${WEBHOOK_EMBEDDING_MODEL:-Qwen/Qwen3-Embedding-0.6B}
      - WEBHOOK_MAX_CHUNK_TOKENS=${WEBHOOK_MAX_CHUNK_TOKENS:-256}
      - WEBHOOK_CHUNK_OVERLAP_TOKENS=${WEBHOOK_CHUNK_OVERLAP_TOKENS:-50}
      - WEBHOOK_HYBRID_ALPHA=${WEBHOOK_HYBRID_ALPHA:-0.5}
      - WEBHOOK_BM25_K1=${WEBHOOK_BM25_K1:-1.5}
      - WEBHOOK_BM25_B=${WEBHOOK_BM25_B:-0.75}
      - WEBHOOK_RRF_K=${WEBHOOK_RRF_K:-60}
      - WEBHOOK_LOG_LEVEL=${WEBHOOK_LOG_LEVEL:-INFO}
    depends_on:
      - firecrawl_db
      - firecrawl_cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:52100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  firecrawl_webhook_worker:
    <<: *common-service
    build:
      context: ./apps/webhook
      dockerfile: Dockerfile
    container_name: firecrawl_webhook_worker
    command: python -m app.worker
    environment:
      - WEBHOOK_REDIS_URL=redis://firecrawl_cache:6379
      - WEBHOOK_DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-firecrawl}:${POSTGRES_PASSWORD}@firecrawl_db:5432/${POSTGRES_DB:-firecrawl_db}
      - WEBHOOK_QDRANT_URL=${WEBHOOK_QDRANT_URL}
      - WEBHOOK_QDRANT_COLLECTION=${WEBHOOK_QDRANT_COLLECTION:-firecrawl_docs}
      - WEBHOOK_VECTOR_DIM=${WEBHOOK_VECTOR_DIM:-1024}
      - WEBHOOK_TEI_URL=${WEBHOOK_TEI_URL}
      - WEBHOOK_EMBEDDING_MODEL=${WEBHOOK_EMBEDDING_MODEL:-Qwen/Qwen3-Embedding-0.6B}
      - WEBHOOK_MAX_CHUNK_TOKENS=${WEBHOOK_MAX_CHUNK_TOKENS:-256}
      - WEBHOOK_CHUNK_OVERLAP_TOKENS=${WEBHOOK_CHUNK_OVERLAP_TOKENS:-50}
      - WEBHOOK_LOG_LEVEL=${WEBHOOK_LOG_LEVEL:-INFO}
    depends_on:
      - firecrawl_cache
      - firecrawl_webhook
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r = redis.from_url('redis://firecrawl_cache:6379'); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  firecrawl:
    driver: bridge
