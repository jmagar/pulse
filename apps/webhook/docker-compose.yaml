# Firecrawl Search Bridge - Docker Compose
# Last Updated: 16:35:00 | 11/05/2025
#
# NOTE: This compose file is minimal because we use external services:
# - Redis: Firecrawl's Redis at 10.1.0.6:4303
# - Qdrant: qdrant.tootie.tv (https)
# - TEI: tei.tootie.tv (https)
#
# Only the bridge API and worker need to run locally.

services:
  # PostgreSQL Database (for timing metrics)
  postgres:
    image: postgres:16-alpine
    container_name: fc-bridge-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: fc_bridge
      POSTGRES_USER: fc_bridge
      POSTGRES_PASSWORD: password
    volumes:
      - fc-bridge-postgres-data:/var/lib/postgresql/data
    networks:
      - fc-bridge-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fc_bridge -d fc_bridge"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Search Bridge API Server
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fc-bridge-api
    restart: unless-stopped
    ports:
      - "52100:52100"
    env_file:
      - .env
    networks:
      - fc-bridge-network
    depends_on:
      postgres:
        condition: service_healthy
      worker:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:52100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Background Worker for Indexing Jobs
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fc-bridge-worker
    restart: unless-stopped
    env_file:
      - .env
    command: python -m app.worker
    networks:
      - fc-bridge-network
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; r = redis.from_url('redis://10.1.0.6:4303'); r.ping()"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  fc-bridge-postgres-data:
    name: fc-bridge-postgres-data

networks:
  fc-bridge-network:
    driver: bridge
    name: fc-bridge-network
